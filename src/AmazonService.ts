import axios from "axios";
import { HttpsProxyAgent } from "https-proxy-agent";

export class AmazonService {
  private static instance: AmazonService;
  private static pending = 0;
  private proxies1 = [
    "http://156.233.89.216:3128",
    "http://154.213.198.215:3128",
    "http://156.228.84.63:3128",
    "http://104.207.58.255:3128",
    "http://156.228.176.114:3128",
    "http://104.207.57.247:3128",
    "http://104.207.45.57:3128",
    "http://154.213.199.44:3128",
    "http://156.233.72.245:3128",
    "http://104.207.56.164:3128",
    "http://156.228.96.142:3128",
    "http://156.228.93.128:3128",
    "http://104.207.57.95:3128",
    "http://104.167.24.124:3128",
    "http://156.228.112.136:3128",
    "http://156.233.95.232:3128",
    "http://156.228.80.253:3128",
    "http://156.233.74.23:3128",
    "http://154.94.14.119:3128",
    "http://104.207.47.182:3128",
    "http://156.228.176.160:3128",
    "http://156.228.181.164:3128",
    "http://156.228.85.143:3128",
    "http://156.253.164.174:3128",
    "http://156.228.100.126:3128",
    "http://156.228.174.155:3128",
    "http://156.228.83.3:3128",
    "http://154.213.195.103:3128",
    "http://156.228.177.35:3128",
    "http://104.167.25.168:3128",
    "http://156.228.83.80:3128",
    "http://156.228.88.56:3128",
    "http://104.207.56.34:3128",
    "http://156.253.177.68:3128",
    "http://154.94.14.204:3128",
    "http://154.213.195.250:3128",
    "http://156.249.138.105:3128",
    "http://104.207.37.72:3128",
    "http://104.167.28.48:3128",
    "http://156.228.183.230:3128",
    "http://156.233.93.252:3128",
    "http://104.207.48.254:3128",
    "http://104.167.28.142:3128",
    "http://154.213.203.144:3128",
    "http://156.228.111.150:3128",
    "http://156.233.85.177:3128",
    "http://156.233.72.101:3128",
    "http://154.94.12.171:3128",
    "http://45.202.79.2:3128",
    "http://156.228.106.215:3128",
    "http://156.228.79.196:3128",
    "http://156.253.175.197:3128",
    "http://45.201.10.183:3128",
    "http://154.94.15.137:3128",
    "http://104.207.44.214:3128",
    "http://104.207.42.150:3128",
    "http://156.228.124.141:3128",
    "http://156.233.90.126:3128",
    "http://156.253.177.250:3128",
    "http://104.207.54.92:3128",
    "http://156.228.95.60:3128",
    "http://156.253.176.19:3128",
    "http://156.233.89.93:3128",
    "http://104.167.26.242:3128",
    "http://156.228.171.173:3128",
    "http://156.228.76.13:3128",
    "http://156.228.125.217:3128",
    "http://104.207.38.168:3128",
    "http://156.228.104.35:3128",
    "http://154.213.197.77:3128",
    "http://156.228.99.158:3128",
    "http://156.228.102.12:3128",
    "http://156.228.111.147:3128",
    "http://45.201.10.154:3128",
    "http://156.228.113.240:3128",
    "http://104.207.41.101:3128",
    "http://156.228.174.82:3128",
    "http://156.228.96.25:3128",
    "http://156.249.137.103:3128",
    "http://156.228.102.44:3128",
    "http://156.249.138.134:3128",
  ];
  private proxies2 = [
    "http://72.10.160.92:21713",
    "http://51.89.255.67:80",
    "http://185.105.102.179:80",
    "http://123.30.154.171:7777",
    "http://72.10.164.178:24789",
    "http://109.176.198.142:80",
    "http://45.92.177.60:8080",
    "http://209.14.119.229:999",
    "http://217.64.149.190:8118",
    "http://67.43.227.226:11449",
    "http://183.240.196.55:38080",
    "http://189.22.234.44:80",
    "http://47.76.144.139:11",
    "http://103.143.197.212:8010",
    "http://72.10.160.170:29479",
    "http://38.51.79.112:1987",
    "http://175.139.233.79:80",
    "http://185.105.102.189:80",
    "http://72.10.160.171:13819",
    "http://172.191.74.198:8080",
    "http://141.11.103.136:8080",
    "http://47.89.184.18:3128",
    "http://159.65.230.46:8888",
    "http://187.204.88.129:8081",
    "http://189.22.234.37:80",
    "http://186.167.80.234:8090",
    "http://41.204.43.30:3128",
    "http://72.10.160.171:27115",
    "http://131.196.219.128:8080",
    "http://183.234.215.11:8443",
    "http://72.10.164.178:8529",
    "http://189.22.234.41:80",
    "http://183.240.46.42:443",
    "http://43.252.107.51:9020",
    "http://103.99.136.66:8080",
    "http://87.248.129.26:80",
    "http://36.64.234.39:8080",
    "http://1.32.48.69:8081",
    "http://27.189.135.52:8089",
    "http://85.117.60.163:8080",
    "http://186.121.234.93:8080",
    "http://178.128.113.118:23128",
    "http://220.248.70.237:9002",
    "http://36.89.212.253:8080",
    "http://106.42.30.243:82",
    "http://47.56.110.204:8989",
    "http://91.92.155.207:3128",
    "http://45.225.120.36:40033",
    "http://101.255.208.238:7888",
    "http://67.43.227.228:9277",
    "http://72.10.160.170:27115",
    "http://36.89.16.186:8866",
    "http://66.29.154.105:3128",
    "http://108.170.12.11:80",
    "http://36.67.194.162:8042",
    "http://45.233.169.25:999",
    "http://103.27.111.156:1080",
    "http://95.84.138.83:8081",
    "http://98.64.128.182:3128",
    "http://219.65.73.81:80",
    "http://123.13.218.68:9002",
    "http://189.22.234.47:80",
    "http://67.43.228.250:17157",
    "http://103.152.112.120:80",
    "http://66.29.154.103:3128",
    "http://162.223.90.130:80",
    "http://84.39.112.144:3128",
    "http://67.43.236.18:30427",
    "http://36.64.10.162:8080",
    "http://157.245.97.60:80",
    "http://123.154.19.95:8085",
    "http://47.91.104.88:3128",
    "http://103.247.13.46:8080",
    "http://113.176.118.255:7654",
    "http://149.129.255.179:119",
    "http://182.253.178.93:8080",
    "http://223.205.96.215:8080",
    "http://67.43.227.228:23193",
    "http://186.96.97.203:999",
    "http://101.66.198.134:8085",
    "http://219.93.101.60:80",
    "http://157.254.53.50:80",
    "http://134.209.29.120:3128",
    "http://108.7.232.77:3128",
    "http://177.244.34.58:999",
    "http://103.93.93.220:3127",
    "http://182.253.140.250:8080",
    "http://103.49.202.252:80",
    "http://143.42.66.91:80",
    "http://185.159.153.234:80",
    "http://67.43.228.253:28811",
    "http://189.22.234.32:80",
    "http://105.174.43.194:8080",
    "http://202.154.19.165:8080",
    "http://189.22.234.36:80",
    "http://183.215.23.242:9091",
    "http://203.175.103.77:8080",
    "http://103.122.137.68:8080",
    "http://4.175.200.138:8080",
    "http://72.10.160.90:1201",
    "http://138.68.60.8:3128",
    "http://113.160.133.32:8080",
    "http://119.8.182.222:3128",
    "http://203.190.46.89:8080",
    "http://51.255.57.241:8080",
    "http://196.20.125.129:8083",
    "http://67.43.228.251:26887",
    "http://72.10.160.174:22843",
    "http://221.231.13.198:1080",
    "http://204.199.105.221:999",
    "http://103.175.46.13:8080",
    "http://133.18.234.13:80",
    "http://186.237.131.122:8080",
    "http://43.129.201.43:443",
    "http://202.154.18.1:4995",
    "http://152.26.229.52:9443",
    "http://47.245.63.175:3389",
    "http://142.93.202.130:3128",
    "http://109.61.42.223:80",
    "http://149.129.226.9:69",
    "http://189.22.234.34:80",
    "http://157.66.16.52:8080",
    "http://154.65.39.8:80",
    "http://85.214.107.177:80",
    "http://51.89.25.53:3128",
    "http://212.113.102.130:27099",
    "http://121.227.146.118:8089",
    "http://101.66.199.168:8085",
    "http://98.8.195.160:443",
    "http://185.191.236.162:3128",
    "http://51.254.78.223:80",
    "http://58.69.117.149:8082",
    "http://103.171.245.32:1080",
    "http://135.181.154.225:80",
    "http://45.143.223.11:8080",
    "http://14.143.130.210:1111",
    "http://72.10.160.172:27115",
    "http://43.156.111.235:59394",
    "http://72.10.164.178:2191",
    "http://45.230.170.30:999",
    "http://194.182.163.117:3128",
    "http://193.34.144.169:80",
    "http://101.255.166.185:8080",
    "http://107.178.105.182:60008",
    "http://49.236.212.134:8888",
    "http://3.145.36.17:8090",
    "http://178.48.68.61:18080",
    "http://60.204.145.212:8888",
    "http://8.218.164.47:12345",
    "http://47.239.217.242:80",
    "http://208.87.243.199:7878",
    "http://120.29.124.131:8080",
    "http://124.122.114.109:8080",
    "http://120.28.210.205:8080",
    "http://50.62.183.223:80",
    "http://72.10.160.90:32805",
    "http://109.123.244.49:80",
    "http://96.0.147.177:443",
    "http://103.165.234.46:8080",
    "http://1.92.79.157:7892",
    "http://204.199.120.18:999",
    "http://89.145.162.81:3128",
    "http://202.169.38.139:9090",
    "http://103.165.155.171:1111",
    "http://47.252.18.37:13",
    "http://72.10.160.171:31133",
    "http://103.130.182.123:8080",
    "http://181.209.111.82:999",
    "http://198.49.68.80:80",
    "http://103.247.15.97:231",
    "http://175.100.103.170:55443",
    "http://121.224.231.143:8089",
    "http://89.117.22.218:8080",
    "http://116.254.99.120:8080",
    "http://138.121.161.175:8390",
    "http://37.232.13.2:8080",
    "http://103.180.196.141:8080",
    "http://67.43.228.251:6963",
    "http://103.178.194.199:1111",
    "http://67.43.236.18:13851",
    "http://190.61.106.97:8080",
    "http://27.189.128.9:8089",
    "http://134.209.23.180:8888",
    "http://38.183.213.232:999",
    "http://67.43.236.18:26133",
    "http://47.238.165.203:59394",
    "http://51.255.57.241:80",
    "http://103.48.160.42:96",
    "http://64.227.172.34:8080",
    "http://113.160.132.195:8080",
    "http://36.37.224.125:8080",
    "http://216.158.246.90:51012",
    "http://38.255.23.131:999",
    "http://27.79.194.186:16000",
    "http://103.165.157.248:8090",
    "http://27.79.248.34:16000",
    "http://161.97.136.251:3128",
    "http://103.175.237.45:8085",
    "http://27.79.148.161:16000",
    "http://27.79.164.240:16000",
    "http://119.2.48.12:9669",
    "http://41.40.175.222:8080",
    "http://27.79.239.226:16000",
    "http://111.132.16.22:3389",
    "http://102.185.234.21:8080",
  ];

  private constructor() {}

  public static getInstance(): AmazonService {
    if (!AmazonService.instance) {
      AmazonService.instance = new AmazonService();
    }

    return AmazonService.instance;
  }

  get<T>(
    url: string,
    callback?: {
      onSuccess?: (data: T) => void;
      onError?: (e: any) => void;
      onFinally?: () => void;
    }
  ) {
    const pendingLimit = 5;
    if (AmazonService.pending >= pendingLimit) {
      setTimeout(() => this.get(url, callback), 200);
      return;
    }
    AmazonService.pending++;

    const httpsAgent = new HttpsProxyAgent(
      this.proxies1[Math.floor(Math.random() * this.proxies1.length)]
    );

    return new Promise<T>(async (resolve) => {
      return axios
        .get<T>(url, { httpsAgent })
        .then((response) => {
          callback?.onSuccess?.(response.data);
          console.log(response.status);
          resolve(response.data);
        })
        .catch((e) => {
          callback?.onError?.(e);
          console.log(e.message);
        })
        .finally(() => {
          callback?.onFinally?.();
          AmazonService.pending--;
        });
    });
  }
}
